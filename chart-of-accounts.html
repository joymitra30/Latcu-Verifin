<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chart of Accounts - Admin</title>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--muted:#6b7280;--accent:#0b63ff}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#0f172a; margin:0; padding:24px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:10px;padding:18px;box-shadow:0 1px 2px rgba(16,24,40,0.04);}
    form.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px;border:1px solid #e6edf3;border-radius:8px;font-size:14px}
    textarea{min-height:72px;resize:vertical}
    .full{grid-column:1/-1}
    .actions{display:flex;gap:10px;align-items:center}
    button{background:var(--accent);color:white;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe}
    .muted{color:var(--muted);font-size:13px}
    .table-wrap{margin-top:18px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
    th{font-weight:600;color:var(--muted);background:#fbfdff}
    .controls{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;padding:6px 8px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:600;font-size:12px}
    .right{display:flex;gap:8px;align-items:center}
    @media (max-width:800px){form.grid{grid-template-columns:1fr}
      .right{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Chart of Accounts</h1>
        <div class="muted">Define and manage accounts used across the accounting system</div>
      </div>
      <div class="right">
        <div class="pill">Demo (local-only)</div>
      </div>
    </header>

    <section class="card">
      <h3 style="margin:0 0 12px 0">Create / Edit Account</h3>
      <form id="coaForm" class="grid" onsubmit="return saveAccount(event)">
        <div>
          <label for="accountCode">Account Code</label>
          <input id="accountCode" name="accountCode" type="text" required placeholder="e.g. 1000" />
        </div>

        <div>
          <label for="accountName">Account Name</label>
          <input id="accountName" name="accountName" type="text" required placeholder="e.g. Cash on Hand" />
        </div>

        <div>
          <label for="accountType">Account Type</label>
          <select id="accountType" name="accountType" required>
            <option value="">Select type</option>
            <option value="Asset">Asset</option>
            <option value="Liability">Liability</option>
            <option value="Equity">Equity</option>
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
          </select>
        </div>

        <div>
          <label for="parentAccount">Parent Account (optional)</label>
          <select id="parentAccount" name="parentAccount">
            <option value="">-- None --</option>
          </select>
        </div>

        <div>
          <label for="currency">Currency</label>
          <select id="currency" name="currency" required>
            <option value="TSH">TSH</option>
            <option value="USD">USD</option>
          </select>
        </div>

        <div>
          <label for="openingBalance">Opening Balance</label>
          <input id="openingBalance" name="openingBalance" type="number" step="0.01" value="0" />
        </div>

        <div>
          <label for="normalBalance">Normal Balance</label>
          <select id="normalBalance" name="normalBalance" required>
            <option value="Debit">Debit</option>
            <option value="Credit">Credit</option>
          </select>
        </div>

        <div>
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>

        <div>
          <label for="taxCode">Tax Code (optional)</label>
          <input id="taxCode" name="taxCode" type="text" placeholder="VAT, GST code or none" />
        </div>

        <div>
          <label for="department">Department / Cost Center (optional)</label>
          <input id="department" name="department" type="text" placeholder="e.g. Sales, Ops" />
        </div>

        <div class="full">
          <label for="description">Description / Notes</label>
          <textarea id="description" name="description" placeholder="Notes about this account"></textarea>
        </div>

        <input type="hidden" id="editingId" />

        <div class="full actions" style="justify-content:flex-end">
          <button type="button" class="ghost small" onclick="resetForm()">Reset</button>
          <button type="submit" class="small">Save Account</button>
        </div>
      </form>

      <div class="table-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="controls">
            <input id="search" type="text" placeholder="Search accounts..." oninput="renderTable()" style="padding:8px;border-radius:8px;border:1px solid #e6edf3" />
            <button class="small ghost" onclick="exportCSV()">Export CSV</button>
          </div>
        </div>

        <table id="accountsTable">
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Type</th>
              <th>Parent</th>
              <th>Currency</th>
              <th>Opening</th>
              <th>Normal</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer style="margin-top:14px;text-align:center;color:var(--muted);font-size:13px">Tip: This is a front-end prototype. Integrate with your backend to persist accounts in your database.</footer>
  </div>

  <script>
    // Simple localStorage-backed demo for Chart of Accounts
    const STORAGE_KEY = 'coa_demo_accounts_v1'
    let accounts = []

    // sample initial accounts if none present
    const SAMPLE = [
      {id: genId(), code:'1000', name:'Assets', type:'Asset', parentId:'', currency:'TSH', opening:0, normal:'Debit', status:'Active'},
      {id: genId(), code:'1100', name:'Current Assets', type:'Asset', parentId:'1000', currency:'TSH', opening:0, normal:'Debit', status:'Active'},
      {id: genId(), code:'2000', name:'Liabilities', type:'Liability', parentId:'', currency:'TSH', opening:0, normal:'Credit', status:'Active'},
      {id: genId(), code:'2100', name:'Accounts Payable', type:'Liability', parentId:'2000', currency:'TSH', opening:0, normal:'Credit', status:'Active'}
    ]

    function genId(){ return 'a'+Math.random().toString(36).slice(2,9) }

    function loadAccounts(){
      const raw = localStorage.getItem(STORAGE_KEY)
      if(!raw){ accounts = SAMPLE.slice(); saveToStorage(); } else { accounts = JSON.parse(raw) }
      renderTable(); populateParentSelect();
    }

    function saveToStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts)) }

    function saveAccount(e){
      if(e) e.preventDefault()
      const id = document.getElementById('editingId').value
      const code = document.getElementById('accountCode').value.trim()
      const name = document.getElementById('accountName').value.trim()
      const type = document.getElementById('accountType').value
      const parentId = document.getElementById('parentAccount').value || ''
      const currency = document.getElementById('currency').value
      const opening = parseFloat(document.getElementById('openingBalance').value || 0) || 0
      const normal = document.getElementById('normalBalance').value
      const status = document.getElementById('status').value
      const taxCode = document.getElementById('taxCode').value.trim()
      const department = document.getElementById('department').value.trim()
      const description = document.getElementById('description').value.trim()

      // basic validations
      if(!code || !name || !type){ alert('Please fill required fields'); return false }

      // prevent duplicate code unless editing same record
      const dup = accounts.find(a=>a.code===code && a.id!==id)
      if(dup){ alert('Account code already exists. Use unique codes.'); return false }

      if(id){ // update
        const idx = accounts.findIndex(a=>a.id===id)
        if(idx>-1){
          accounts[idx] = {...accounts[idx], code, name, type, parentId, currency, opening, normal, status, taxCode, department, description}
        }
      } else {
        // create new
        const newAcc = { id: genId(), code, name, type, parentId, currency, opening, normal, status, taxCode, department, description }
        accounts.push(newAcc)
      }

      saveToStorage(); renderTable(); populateParentSelect(); resetForm();
      return false
    }

    function renderTable(){
      const tbody = document.querySelector('#accountsTable tbody')
      tbody.innerHTML = ''
      const q = (document.getElementById('search').value||'').toLowerCase()
      // sort by code numeric if possible
      const sorted = accounts.slice().sort((a,b)=> (a.code||'').localeCompare(b.code||'', undefined, {numeric:true}))
      for(const acc of sorted){
        if(q && !(`${acc.code} ${acc.name} ${acc.type}`.toLowerCase().includes(q))) continue
        const parentName = accounts.find(p=>p.code===acc.parentId || p.id===acc.parentId)?.name || ''
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td>${acc.code}</td>
          <td>${acc.name}</td>
          <td>${acc.type}</td>
          <td>${parentName}</td>
          <td>${acc.currency}</td>
          <td style="text-align:right">${Number(acc.opening).toLocaleString()}</td>
          <td>${acc.normal}</td>
          <td>${acc.status}</td>
          <td style="text-align:right">
            <button class="small ghost" onclick="editAccount('${acc.id}')">Edit</button>
            <button class="small" onclick="deleteAccount('${acc.id}')">Delete</button>
          </td>
        `
        tbody.appendChild(tr)
      }
    }

    function populateParentSelect(){
      const sel = document.getElementById('parentAccount')
      const current = sel.value
      sel.innerHTML = '<option value="">-- None --</option>'
      // allow selecting by code (safer for import) and include hierarchy
      const sorted = accounts.slice().sort((a,b)=> (a.code||'').localeCompare(b.code||'', undefined, {numeric:true}))
      for(const acc of sorted){
        const opt = document.createElement('option')
        opt.value = acc.code // parent stored by code for easier imports
        opt.textContent = acc.code+' — '+acc.name
        sel.appendChild(opt)
      }
      sel.value = current
    }

    function editAccount(id){
      const acc = accounts.find(a=>a.id===id)
      if(!acc) return
      document.getElementById('editingId').value = acc.id
      document.getElementById('accountCode').value = acc.code
      document.getElementById('accountName').value = acc.name
      document.getElementById('accountType').value = acc.type
      document.getElementById('parentAccount').value = acc.parentId || acc.parentId==='' ? acc.parentId : ''
      document.getElementById('currency').value = acc.currency
      document.getElementById('openingBalance').value = acc.opening
      document.getElementById('normalBalance').value = acc.normal
      document.getElementById('status').value = acc.status
      document.getElementById('taxCode').value = acc.taxCode||''
      document.getElementById('department').value = acc.department||''
      document.getElementById('description').value = acc.description||''
      window.scrollTo({top:0,behavior:'smooth'})
    }

    function deleteAccount(id){
      if(!confirm('Delete this account? This cannot be undone in demo.')) return
      accounts = accounts.filter(a=>a.id!==id)
      saveToStorage(); renderTable(); populateParentSelect();
    }

    function resetForm(){
      document.getElementById('coaForm').reset();
      document.getElementById('editingId').value = '';
      // reset defaults
      document.getElementById('currency').value = 'TSH'
      document.getElementById('normalBalance').value = 'Debit'
      document.getElementById('status').value = 'Active'
    }

    function exportCSV(){
      const headers = ['code','name','type','parent','currency','opening','normal','status','taxCode','department','description']
      const rows = accounts.map(a=>[a.code,a.name,a.type,a.parentId,a.currency,a.opening,a.normal,a.status,a.taxCode||'',a.department||'',(a.description||'')])
      const csv = [headers.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""') }"`).join(','))].join('\n')
      const blob = new Blob([csv], {type:'text/csv'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href = url; a.download = 'chart_of_accounts.csv'; a.click(); URL.revokeObjectURL(url)
    }

    // initialize
    loadAccounts()
  </script>
</body>
</html>
